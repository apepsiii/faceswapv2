<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ambil Foto - AR Photo</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
    body {
        background: #000;
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        overflow: hidden;
        position: relative;
    }
    
    .header {
        position: absolute;
        top: 20px;
        left: 20px;
        right: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        z-index: 30;
    }
    
    .logo {
        width: 120px;
    }
    
    .credit-display {
        background: rgba(0, 0, 0, 0.7);
        color: #fff;
        padding: 10px 20px;
        border-radius: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
        backdrop-filter: blur(10px);
    }
    
    .credit-display i {
        color: #00ffcc;
        font-size: 1.2rem;
    }
    
    .camera-container {
        position: relative;
        width: 100%;
        height: 100%;
        aspect-ratio: 9/16;
        background: #000;
        overflow: hidden;
    }
    #video, #characterVideo {
        position: absolute;
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    #video {
        transform: scaleX(-1);
    }
    #characterVideo {
        position: absolute;
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: none;
        z-index: 10;
    }
    .overlay {
        position: absolute;
        top: 10%;
        left: 0; right: 0;
        display: flex;
        justify-content: center;
        font-size: 6rem;
        font-weight: bold;
        color: #fff;
        z-index: 10;
        display: none;
    }
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        display: none;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        z-index: 1000;
        color: white;
    }

    .spinner {
        width: 50px;
        height: 50px;
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-top: 4px solid #00ffcc;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .loading-text {
        font-size: 1.2rem;
        margin-bottom: 10px;
    }

    .loading-subtext {
        font-size: 0.9rem;
        opacity: 0.8;
    }

    .black-background {
        position: absolute;
        top: 0; left: 0; right: 0; bottom: 0;
        background: #000;
        z-index: 5;
        display: none;
    }
</style>
</head>
<body>

<div class="header">
    <img src="/static/images/logo.png" alt="Logo" class="logo">
    <div class="credit-display">
        <i class="fas fa-coins"></i>
        <span>Credits: <span id="creditCount">-</span></span>
    </div>
</div>

<div class="camera-container">
    <video id="video" autoplay muted playsinline></video>
    <video id="characterVideo" muted playsinline></video>
    <div id="blackBackground" class="black-background"></div>
    <canvas id="canvas" style="display:none;"></canvas>
    <div id="overlay" class="overlay">READY</div>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <div class="loading-text">Sedang memproses...</div>
        <div class="loading-subtext">Mohon tunggu sebentar</div>
    </div>


</div>

<audio id="cekrekSound" src="/static/images/cekrek.mp3" preload="auto"></audio>

<script>
let videoStream = null;
const video = document.getElementById("video");
const characterVideo = document.getElementById("characterVideo");
const canvas = document.getElementById("canvas");
const overlay = document.getElementById("overlay");
const cekrekSound = document.getElementById("cekrekSound");
let existingTimer = null;

let currentUser = null;

// Check authentication
const token = localStorage.getItem('token');
if (!token) {
    window.location.replace('/login');
}

// Get selected character
const characterData = localStorage.getItem("selectedCharacter");
if (!characterData) {
    window.location.replace("ar-character");
}
const selectedCharacter = JSON.parse(characterData);

// Load user data and start camera
document.addEventListener('DOMContentLoaded', async function() {
    await loadUserData();
    await startCamera();
});

// Load user data and credit info
async function loadUserData() {
    try {
        const response = await fetch('/api/me', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (response.ok) {
            const userData = await response.json();
            if (userData.success && userData.user) {
                currentUser = userData.user;
                document.getElementById('creditCount').textContent = userData.user.credit_balance || 0;
                

            }
        }
    } catch (error) {
        console.error('Error loading user data:', error);
    }
}

// Start camera
async function startCamera() {
    try {
        videoStream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = videoStream;

        video.addEventListener("loadedmetadata", () => {
            setTimeout(() => {
                resetAllState();
                showReadyThenCountdown();
            }, 500);
        }, { once: true });
    } catch (error) {
        alert("Tidak dapat mengakses kamera.");
        console.error('Camera error:', error);
    }
}

function resetAllState() {
    overlay.style.display = "none";
    overlay.textContent = "";

    if (characterVideo) {
        characterVideo.pause();
        characterVideo.currentTime = 0;
        characterVideo.style.display = "none";
    }

    if (existingTimer) {
        clearInterval(existingTimer);
        existingTimer = null;
    }
}

function showReadyThenCountdown() {
    fetch('/relay?state=on')
    .then(() => console.log("Lampu HIDUP"))
    .catch(() => console.log("Gagal Hidupkan lampu"));
    
    overlay.textContent = "READY";
    overlay.style.display = "flex";

    setTimeout(() => {
        startCountdown();
    }, 3500);
}

function startCountdown() {
    let count = 5;
    overlay.textContent = count;

    // Play character video
    if (selectedCharacter.name.toLowerCase().includes("jumbo")) {
        characterVideo.src = "/static/ar_assets/thumbnail/bimodanteman.webm";
        characterVideo.style.display = "block";
        characterVideo.play();
    } else if (selectedCharacter.name.toLowerCase().includes("minion")) {
        characterVideo.src = "/static/ar_assets/thumbnail/minion3biji.webm";
        characterVideo.style.display = "block";
        characterVideo.play();
    }

    existingTimer = setInterval(() => {
        count--;
        overlay.textContent = count;

        if (count === 4) {
            cekrekSound.play();
        }

        if (count <= 0) {
            clearInterval(existingTimer);
            existingTimer = null;
            overlay.style.display = "none";

            setTimeout(() => {
                capturePhoto();

                fetch('/relay?state=off')

                .then(() => console.log("Lampu MATI"))
                .catch(() => console.log("Gagal matikan lampu"));
            }, 1000);
        }
    }, 1000);
}

function capturePhoto() {
    showLoading('Sedang memproses foto Anda...', 'Mohon tunggu beberapa saat');
    const originalWidth = video.videoWidth;


    const originalHeight = video.videoHeight;

    let cropWidth = originalWidth;
    let cropHeight = originalWidth * 16 / 9;

    if (cropHeight > originalHeight) {
        cropHeight = originalHeight;
        cropWidth = originalHeight * 9 / 16;
    }

    const offsetX = (originalWidth - cropWidth) / 2;
    const offsetY = (originalHeight - cropHeight) / 2;

    canvas.width = cropWidth;
    canvas.height = cropHeight;
    const ctx = canvas.getContext("2d");

    ctx.save();
    ctx.translate(cropWidth, 0);
    ctx.scale(-1, 1);
    ctx.drawImage(video, offsetX, offsetY, cropWidth, cropHeight, 0, 0, cropWidth, cropHeight);
    ctx.restore();

    // Convert to blob and upload
    canvas.toBlob(async (blob) => {
        await uploadPhoto(blob);
    }, "image/jpeg", 1.0);
}

async function uploadPhoto(blob) {
    try {
        const formData = new FormData();
        // FIX: Use 'photo' as the key for the file to match the backend API
        formData.append("photo", blob, "capture.jpg");
        // FIX: Use 'character_name' to match the backend API
        formData.append("character_name", selectedCharacter.name);

        // FIX: Use the correct API endpoint
        const response = await fetch("/api/ar/photo", {
            method: "POST",
            headers: {
                'Authorization': `Bearer ${token}`
            },
            body: formData
        });

        const data = await response.json();

        if (response.ok && data.success) {
            // Update credit display by reloading user data

            await loadUserData();
            
            // Redirect to result page using the correct filename from the response
            const resultUrl = `/ar-result?img=${encodeURIComponent(data.data.result_filename)}`;
            window.location.replace(resultUrl);
            
        } else {
            // Enhanced error logging
            console.error('Upload failed. Full server response:', data);
            
            let errorMessage = "Gagal simpan foto: Unknown error.";
            if (data.detail) {
                // Handle structured error from FastAPI
                if (typeof data.detail === 'object' && data.detail.message) {
                    errorMessage = data.detail.message;
                    console.error("Server Traceback:\n", data.detail.traceback);
                } else {
                    errorMessage = data.detail;
                }
            } else if (data.error) {
                errorMessage = data.error;
            }

            if (response.status === 402) {
                alert("Credit tidak mencukupi! Anda akan diarahkan ke halaman pembayaran.");
                window.location.replace('/ar_payment');
            } else {
                alert("Gagal simpan foto: " + errorMessage);
                resetToCamera();
            }
        }
        
    } catch (error) {
        console.error('Network or unexpected error during upload:', error);
        alert("Koneksi gagal atau terjadi kesalahan tak terduga. Silakan coba lagi.");
        resetToCamera();
    }
}


function showLoading(text = 'Loading...', subtext = '') {
    const overlay = document.getElementById('loadingOverlay');
    const textElement = overlay.querySelector('.loading-text');
    const subtextElement = overlay.querySelector('.loading-subtext');
    
    textElement.textContent = text;
    subtextElement.textContent = subtext;
    overlay.style.display = 'flex';
}

function hideLoading() {
    document.getElementById('loadingOverlay').style.display = 'none';
}

function resetToCamera() {
    video.style.display = "block";
    hideLoading();
    
    setTimeout(() => {
        resetAllState();
        showReadyThenCountdown();
    }, 2000);
}


// Cleanup on page unload
window.addEventListener("beforeunload", () => {
    if (videoStream) {
        videoStream.getTracks().forEach(track => track.stop());
    }
});
</script>

</body>
</html>
